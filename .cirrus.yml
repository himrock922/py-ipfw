freebsd_instance:
  image: freebsd-12-0-release-amd64

task:
  install_script:
    - pkg update
    - pkg install -y qjail
  networking_script:
    - kldload if_bridge
    - kldload if_epair
    - kldstat
    - sysrc gateway_enable=YES
    - sysctl net.inet.ip.forwarding=1
    - sysctl security.jail.allow_raw_sockets=1
    - kldload ipfw ; sysctl net.inet.ip.fw.enable=0
    - ifconfig bridge create
    - ifconfig epair create
    - ifconfig
    - ifconfig bridge0 192.168.0.1/24
    - ifconfig bridge0 mtu 1460
    - ifconfig epair0a mtu 1460
    - ifconfig epair0b mtu 1460
    - ifconfig bridge0 addm vtnet0
    - cat /etc/resolv.conf
  qjail_script:
    - ifconfig
    - qjail install -h ftp3.jp.freebsd.org
    - qjail create -n lo0 -4 127.0.0.1 jail1
    - ifconfig vtnet0 | grep -E \(inet\) | awk '{printf $2}' > host_address > host_address
    - cat jail_setting2.txt host_address jail_setting3.txt >> jail_setting.txt
    - cat /usr/local/etc/qjail.config/jail1
    - cp jail_setting.txt /usr/local/etc/qjail.config/jail1
    - qjail start jail1
    - netstat -rn
    - ifconfig bridge0 addm epair0b
    - ifconfig bridge0 up
    - ifconfig
    - jexec jail1 ifconfig
    - jexec jail1 echo 'search c.cirrus-ci-community.internal google.internal' > /etc/resolv.conf
    - jexec jail1 echo 'nameserver 169.254.169.254' >> /etc/resolv.conf
    - jexec jail1 cat /etc/resolv.conf
    - jexec jail1 sysrc firewall_enable=YES
    - jexec jail1 echo 'firewall_type="open"' >> /etc/rc.conf
    - jexec jail1 service ipfw start
    - jexec jail1 ipfw zero
    - jexec jail1 ipfw add 10 allow all from any to any
    - jexec jail1 ipfw list
    - jexec jail1 netstat -rn
    - jexec jail1 ping -c 4 10.128.0.38
    - jexec jail1 pkg update
    - jexec jail1 pkg install -y git
